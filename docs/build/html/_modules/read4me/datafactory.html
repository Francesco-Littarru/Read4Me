<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>read4me.datafactory &mdash; Read4Me 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Read4Me
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Telegram Bot</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.telegram_module.html">Main Telegram Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.custom_filters.html">Telegram Custom Filters</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html">1. Customize the project .ini files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html#virtual-environment-venv">2. Virtual environment (venv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html#install-the-project">3. Install the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html#generate-topics-and-models">4. Generate topics and models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html#configure-the-bot-with-botfather">5. Configure the bot with BotFather</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.project_config.html#run-the-bot">6. Run the bot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.datafactory.html">Dataset Creation module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.topicsprocessor.html">Process Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.docprocessing.html">Process Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.userbase.html">Manage users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.models.html">Retrieve models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.scripts.make_corpus.html">Corpus script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../read4me.scripts.topics.html">Topics script</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Read4Me</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">read4me.datafactory</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for read4me.datafactory</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">**Preliminary information.**</span>
<span class="sd">****************************</span>

<span class="sd">With the datafactory module you can build a corpus of text documents, using the News</span>
<span class="sd">Dataset repository of the open `CommonCrawl Project &lt;https://commoncrawl.org/&gt;`_.</span>

<span class="sd">**What classes are there?**</span>

<span class="sd">* :class:`DataPaths`: A metadata container used to initialize a CorpusBuilder instance.</span>
<span class="sd">* :class:`CorpusBuilder`: The corpus generator.</span>

<span class="sd">**How can you use it?**</span>

<span class="sd">.. note::</span>

<span class="sd">    To start building a corpus you need to download and extract one index file from</span>
<span class="sd">    the list of monthly News Dataset indexes at https://data.commoncrawl.org/crawl-data/CC-NEWS/index.html.</span>
<span class="sd">    An index file contains a list of partial URLs for a month worth of news articles.</span>
<span class="sd">    Initializing a DataPaths instance with the index will also complete the URLs with a valid prefix.</span>

<span class="sd">The extracted dataset files and the corpus files are stored respectively as text and pickle files</span>
<span class="sd">inside a dedicated directory of your choice.</span>
<span class="sd">The text files contain the original documents as extracted from the archives, one for each line, without duplicates,</span>
<span class="sd">while the pickle files contain the processed texts in binary format for easy memory loading.</span>

<span class="sd">Building and loading the corpus can be done in few steps:</span>

<span class="sd">1. Define the metadata.</span>
<span class="sd">2. Generate the corpus.</span>
<span class="sd">3. Load and use the corpus.</span>

<span class="sd">**1. Define the metadata.**</span>
<span class="sd">***************************</span>

<span class="sd">Initialize a DataPaths instance with the index file and other information.</span>

<span class="sd">Example:</span>
<span class="sd">Use an index file called &quot;warc.paths&quot;, select from it only the first</span>
<span class="sd">10 lines (archives) to be used.</span>
<span class="sd">The designated path to save the corpus files is the directory</span>
<span class="sd">&quot;corpus/&quot; and the vocabulary will be saved inside of it as &quot;vocab.txt&quot;.</span>
<span class="sd">If the directory &quot;corpus/&quot; is not already present it will be created.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    datapaths = DataPaths(</span>
<span class="sd">        warc_index=pathlib.Path(&quot;warc.paths&quot;),</span>
<span class="sd">        range_start=0, range_stop=9,</span>
<span class="sd">        text_vocab=pathlib.Path(&quot;corpus/vocab.txt&quot;),</span>
<span class="sd">        corpus_dir=pathlib.Path(&quot;corpus&quot;))``</span>

<span class="sd">The metadata is ready.</span>

<span class="sd">**2. Generate the corpus.**</span>
<span class="sd">***************************</span>

<span class="sd">You can generate the corpus in few steps:</span>

<span class="sd">Initialize an instance with the metadata and then set where to save the status file.</span>
<span class="sd">The status file contains the metadata and other information to reload the corpus once it has been generated.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    cb = CorpusBuilder(datapaths)</span>
<span class="sd">    cb.set_status_path(pathlib.Path(&quot;status.pkl&quot;))</span>

<span class="sd">Download and extract the archives into txt files.</span>
<span class="sd">The archives are those selected from the index file.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    cb.generate_texts_from_index()</span>

<span class="sd">Process the text files and generate the corpus pickle files.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    cb.load_and_clean_origin()</span>

<span class="sd">Save the status of the corpus into a file.</span>
<span class="sd">The status contains all relevant information for loading the corpus.</span>
<span class="sd">The corpus is not serialized because it is already stored separately in the pickle files.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    cb.save_status()</span>

<span class="sd">**3. Load and use the corpus.**</span>
<span class="sd">*******************************</span>

<span class="sd">First load the status containing the metadata, then load the corpus, using the metadata to locate the right corpus files.</span>

<span class="sd">.. code-block::</span>

<span class="sd">    cb = CorpusBuilder.load_status()</span>
<span class="sd">    cb.load_corpus()</span>

<span class="sd">The :attr:`corpus &lt;CorpusBuilder.corpus&gt;` is formatted as a list of documents,</span>
<span class="sd">where each document can be either a string or a list of words, the default is a list of words.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Self</span><span class="p">,</span> <span class="n">Iterator</span>

<span class="kn">from</span> <span class="nn">ftlangdetect</span> <span class="kn">import</span> <span class="n">detect</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">trafilatura</span>
<span class="kn">from</span> <span class="nn">warcio.archiveiterator</span> <span class="kn">import</span> <span class="n">ArchiveIterator</span>
<span class="kn">import</span> <span class="nn">wget</span>

<span class="n">tlog</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;trafilatura&quot;</span><span class="p">)</span>
<span class="n">tlog</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># deactivate logging from trafilatura</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(filename)s</span><span class="s2"> </span><span class="si">%(funcName)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;datafactory&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>


<div class="viewcode-block" id="DataPaths"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.DataPaths">[docs]</a><span class="k">class</span> <span class="nc">DataPaths</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup of the metadata for the creation of the corpus.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">warc_index</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                 <span class="n">range_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">range_stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">text_vocab</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                 <span class="n">corpus_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the list of file names of the corpus, both in txt and pickle format.</span>
<span class="sd">        Define the directory location where to save the files and the txt-vocabulary Path/name.\n</span>
<span class="sd">        The file names are extracted from the index file, also called &quot;WARC file list&quot;,</span>
<span class="sd">        which MUST be one of those available at https://data.commoncrawl.org/crawl-data/CC-NEWS/index.html.</span>
<span class="sd">        The index file is a list of URLs suffixes for the &quot;News Dataset&quot;.</span>
<span class="sd">        The initialization generates valid URLs for the archives selected from the index such that</span>
<span class="sd">        the completed URLs point to downloadable archives in WARC format.</span>

<span class="sd">        :param warc_index: Path to the index file.</span>
<span class="sd">        :param range_start: Positional number of the first archive in the index to use.</span>
<span class="sd">        :param range_stop: Positional number of the last archive in the index to use.</span>
<span class="sd">        :param text_vocab: Path to text vocabulary file, if it exists it will be overwritten.</span>
<span class="sd">        :param corpus_dir: Path to the corpus directory, if it doesn&#39;t exist it will be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__warc_index</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__text_corpus_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># txt files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pkl_corpus_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># pkl files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__text_vocab</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">text_vocab</span>  <span class="c1"># easily readable vocabulary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_corpus_dir</span><span class="p">(</span><span class="n">corpus_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__read_warc_index</span><span class="p">(</span><span class="n">warc_index</span><span class="p">,</span> <span class="n">range_start</span><span class="p">,</span> <span class="n">range_stop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__read_warc_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">istart</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">istop</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate the list of text and pickle file names using the warc index.</span>

<span class="sd">        :param path: Index Path.</span>
<span class="sd">        :param istart: First line to read.</span>
<span class="sd">        :param istop: Last line to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">index_file</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">index_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">istart</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">istop</span><span class="p">:</span>
                        <span class="n">arc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">arc</span><span class="p">)</span>
                        <span class="n">arc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://data.commoncrawl.org/</span><span class="si">{</span><span class="n">arc</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__warc_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arc</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warc index generated.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_files</span><span class="p">()</span>  <span class="c1"># generate corpus text and pickle file names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File not found&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span>

    <span class="k">def</span> <span class="nf">__corpus_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate valid Paths for the corpus text and pickle files, using the index as reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">url_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warc_index</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CC-NEWS-[0-9-]+&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url_index</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
            <span class="n">path_pkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CC-NEWS-[0-9-]+&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">url_index</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__text_corpus_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pkl_corpus_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_pkl</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Corpus file names generated.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">warc_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of the URLs of the index.\n</span>
<span class="sd">        The URLs point to downloadable warc archives from https://data.commoncrawl.org/.</span>

<span class="sd">        :return: List of URLs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__warc_index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text_corpus_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of the Paths for the text files of the corpus.</span>

<span class="sd">        :return: List of Paths of text files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__text_corpus_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pkl_corpus_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of the Paths for the pickle files of the corpus.</span>

<span class="sd">        :return: List of Paths of pickle files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pkl_corpus_files</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">text_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Path of the vocabulary for the corpus.</span>

<span class="sd">        :return: Path to the vocabulary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__text_vocab</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corpus_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Path of the corpus directory.</span>

<span class="sd">        :return: Path of the corpus directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span>

<div class="viewcode-block" id="DataPaths.set_corpus_dir"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.DataPaths.set_corpus_dir">[docs]</a>    <span class="k">def</span> <span class="nf">set_corpus_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Path to the directory where the corpus will be saved.</span>
<span class="sd">        Create the directory if it does not exist.</span>

<span class="sd">        :param dir_path: Path to the corpus directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2"> found.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span> <span class="o">=</span> <span class="n">dir_path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Text corpus directory set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__corpus_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CorpusBuilder"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder">[docs]</a><span class="k">class</span> <span class="nc">CorpusBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is responsible for generating a normalized text corpus from the News Dataset of the CommonCrawl project.</span>
<span class="sd">    It is possible to download, extract, normalize and serialize the corpus with using an instance of this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__stop_set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;ve&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="s1">&#39;say&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;people&#39;</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;th&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;°&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="s1">&#39;come&#39;</span><span class="p">,</span> <span class="s1">&#39;thing&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;do&#39;</span><span class="p">,</span> <span class="s1">&#39;am&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;have&#39;</span><span class="p">,</span> <span class="s1">&#39;take&#39;</span><span class="p">}</span>
    <span class="n">__pos_set</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># &quot;ADJ&quot;,      #: &quot;adjective&quot;</span>
        <span class="c1"># &quot;ADP&quot;,      #: &quot;adposition&quot;,</span>
        <span class="c1"># &quot;ADV&quot;,      #: &quot;adverb&quot;,</span>
        <span class="c1"># &quot;AUX&quot;,      #: &quot;auxiliary&quot;,</span>
        <span class="c1"># &quot;CONJ&quot;,     #: &quot;conjunction&quot;,</span>
        <span class="c1"># &quot;CCONJ&quot;,    #: &quot;coordinating conjunction&quot;,</span>
        <span class="c1"># &quot;DET&quot;,      #: &quot;determiner&quot;,</span>
        <span class="c1"># &quot;INTJ&quot;,     #: &quot;interjection&quot;,</span>
        <span class="s2">&quot;NOUN&quot;</span><span class="p">,</span>  <span class="c1">#: &quot;noun&quot;,</span>
        <span class="c1"># &quot;NUM&quot;,      #: &quot;numeral&quot;,</span>
        <span class="c1"># &quot;PART&quot;,     #: &quot;particle&quot;,</span>
        <span class="c1"># &quot;PRON&quot;,     #: &quot;pronoun&quot;,</span>
        <span class="c1"># &quot;PROPN&quot;,    #: &quot;proper noun&quot;,</span>
        <span class="c1"># &quot;PUNCT&quot;,    #: &quot;punctuation&quot;,</span>
        <span class="c1"># &quot;SCONJ&quot;,    #: &quot;subordinating conjunction&quot;,</span>
        <span class="c1"># &quot;SYM&quot;,      #: &quot;symbol&quot;,</span>
        <span class="c1"># &quot;VERB&quot;,  #: &quot;verb&quot;,</span>
        <span class="c1"># &quot;X&quot;,        #: &quot;other&quot;,</span>
        <span class="c1"># &quot;EOL&quot;,      #: &quot;end of line&quot;,</span>
        <span class="c1"># &quot;SPACE&quot;     #: &quot;space&quot;,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_paths</span><span class="p">:</span> <span class="n">DataPaths</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new :class:`CorpusBuilder` instance.\n</span>
<span class="sd">        To load a previous instance, call :meth:`~CorpusBuilder.load_status()` followed by</span>
<span class="sd">        :meth:`~CorpusBuilder.load_corpus()`.</span>

<span class="sd">        :param data_paths: :class:`DataPaths` instance, metadata for the environment of the corpus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="p">:</span> <span class="n">DataPaths</span> <span class="o">=</span> <span class="n">data_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span>  <span class="c1"># Path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__split</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># If True, the documents in the corpus are lists of words.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__word_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="CorpusBuilder.generate_texts_from_index"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.generate_texts_from_index">[docs]</a>    <span class="k">def</span> <span class="nf">generate_texts_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_local_archive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_archive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_txt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the warc archives and extract their content into text files in the corpus directory.</span>

<span class="sd">        :param check_local_archive: If true, download only the archives that have not been already downloaded.</span>
<span class="sd">        :param keep_archive: Do not delete the archives after extraction.</span>
<span class="sd">        :param check_txt: If True, download and extract only the archives for which there is not a corresponding</span>
<span class="sd">                          text file in the corpus directory.</span>
<span class="sd">        :param min_len: Minimum document length in number of words.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">warc_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Warc index not defined!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">archive_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">warc_index</span><span class="p">):</span>
            <span class="n">_a_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CC-NEWS-[0-9-]+\.warc\.gz&quot;</span><span class="p">,</span> <span class="n">archive_url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">archive_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_paths</span><span class="o">.</span><span class="n">corpus_dir</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">_a_name</span><span class="p">)</span>
            <span class="n">txt_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_corpus_files</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>

            <span class="n">download_archive</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">wget</span><span class="o">.</span><span class="n">download</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">archive_url</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_paths</span><span class="o">.</span><span class="n">corpus_dir</span><span class="p">))</span>
            <span class="n">extract_text</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">extract_text_from_archive</span><span class="p">,</span>
                                   <span class="n">archive</span><span class="o">=</span><span class="n">archive_name</span><span class="p">,</span>
                                   <span class="n">text_path</span><span class="o">=</span><span class="n">txt_file_name</span><span class="p">,</span>
                                   <span class="n">min_len</span><span class="o">=</span><span class="n">min_len</span><span class="p">)</span>
            <span class="n">deduplicate_lines</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">deduplicate_lines_in_txt</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">txt_file_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_txt</span><span class="p">:</span>  <span class="c1"># look for the text file</span>
                <span class="k">if</span> <span class="n">txt_file_name</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">txt_file_name</span><span class="si">}</span><span class="s2"> found.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">txt_file_name</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">archive_name</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archive not found, downloading: </span><span class="si">{</span><span class="n">archive_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">download_archive</span><span class="p">()</span>
                    <span class="n">extract_text</span><span class="p">()</span>
                    <span class="n">deduplicate_lines</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">check_local_archive</span><span class="p">:</span>  <span class="c1"># look for the archive</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">archive_name</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archive not found, downloading: </span><span class="si">{</span><span class="n">archive_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">download_archive</span><span class="p">()</span>
                <span class="n">extract_text</span><span class="p">()</span>
                <span class="n">deduplicate_lines</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># start from scratch</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading archive: </span><span class="si">{</span><span class="n">archive_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">download_archive</span><span class="p">()</span>
                <span class="n">extract_text</span><span class="p">()</span>
                <span class="n">deduplicate_lines</span><span class="p">()</span>

            <span class="c1"># delete archive if present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_archive</span> <span class="ow">and</span> <span class="n">archive_name</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">archive_name</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted archive: </span><span class="si">{</span><span class="n">archive_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.extract_text_from_archive"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.extract_text_from_archive">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_text_from_archive</span><span class="p">(</span><span class="n">archive</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">text_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the text documents from a warc archive and save it in a text file.</span>

<span class="sd">        Each line in the text file represents a document.</span>

<span class="sd">        :param archive: Archive to process.</span>
<span class="sd">        :param text_path: Text file to write to.</span>
<span class="sd">        :param min_len: Threshold on the minimum number of words, discard document otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">,</span> \
                <span class="n">text_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">processed</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Extracting </span><span class="si">{</span><span class="n">archive</span><span class="si">}</span><span class="s2">, writing to </span><span class="si">{</span><span class="n">text_path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">ArchiveIterator</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">rec_type</span> <span class="o">==</span> <span class="s1">&#39;response&#39;</span><span class="p">:</span>
                    <span class="n">html</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">content_stream</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">bare_extraction</span><span class="p">(</span><span class="n">filecontent</span><span class="o">=</span><span class="n">html</span><span class="p">,</span>
                                                       <span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span>
                                                       <span class="n">target_language</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\n\r\v\f]&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;raw_text&quot;</span><span class="p">])</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">min_len</span><span class="p">:</span>
                            <span class="n">processed</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extraction of </span><span class="si">{</span><span class="n">archive</span><span class="si">}</span><span class="s2"> completed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.load_and_clean_origin"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.load_and_clean_origin">[docs]</a>    <span class="k">def</span> <span class="nf">load_and_clean_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">pos</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">stop</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">only_missing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="n">n_process</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the raw text corpus and generate a normalized corpus.</span>
<span class="sd">        Save the normalized corpus in pickle files and generate a vocabulary for it.</span>

<span class="sd">        :param split: If True, the documents are saved as list of words.</span>
<span class="sd">        :param pos: Part of Speech set, if None use class defined one.</span>
<span class="sd">        :param stop: Stopword set, if None use class defined one.</span>
<span class="sd">        :param only_missing: If True, process only the text files for which there is not a corresponding pickle file.</span>
<span class="sd">        :param n_process: Number of cores to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">__pos_set</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">__stop_set</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__split</span> <span class="o">=</span> <span class="n">split</span>

        <span class="n">existing_ones</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">only_missing</span><span class="p">:</span>
            <span class="n">to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">f_id</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_corpus_files</span><span class="p">)</span>
                          <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">pkl_corpus_files</span><span class="p">[</span><span class="n">f_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>
            <span class="n">existing_ones</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">pkl_corpus_files</span><span class="p">[</span><span class="n">f_id</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">f_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_corpus_files</span><span class="p">)</span>
                             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">pkl_corpus_files</span><span class="p">[</span><span class="n">f_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_ones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reloading pickle files.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_corpus</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">existing_ones</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_corpus_files</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading spacy model.&quot;</span><span class="p">)</span>
        <span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;en_core_web_md&quot;</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ner&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">corpus</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">__corpus_iterator</span><span class="p">(</span><span class="n">to_process</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Spacy pipe.&quot;</span><span class="p">)</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">corpus</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">n_process</span><span class="o">=</span><span class="n">n_process</span><span class="p">)</span>
            <span class="n">_docs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">detect</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">language</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;en&#39;</span> <span class="ow">and</span> <span class="n">language</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">:</span>
                    <span class="n">_docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">lemma_</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">doc</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pos_</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">]))</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="n">_docs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pipe completed.&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Regex cleaning.&quot;</span><span class="p">)</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">clean_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span> <span class="k">if</span> <span class="n">doc</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]]</span>
            <span class="n">pkl_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">pkl_corpus_files</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_ones</span><span class="p">)</span> <span class="o">+</span> <span class="n">c_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">,</span> <span class="o">*</span><span class="n">docs</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">pkl_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pkl_file</span><span class="si">}</span><span class="s2"> saved.&quot;</span><span class="p">)</span>

        <span class="n">_corpus</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;_corpus_temp_&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">_corpus</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">CorpusBuilder</span><span class="o">.</span><span class="n">deduplicate_lines_in_txt</span><span class="p">(</span><span class="n">_corpus</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">_corpus</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">_corpus</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>  <span class="c1"># remove temporary corpus file</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done cleaning.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__make_vocab</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__make_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a txt vocabulary of words and their count sorted by most to least frequent.</span>
<span class="sd">        The first line in the vocabulary is the total word count.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Making vocabulary with counts.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__split</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary generated, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> entries.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__word_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__word_count</span><span class="si">}</span><span class="s2"> total tokens.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_vocab</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">voc</span><span class="p">:</span>
            <span class="n">voc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__word_count</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__vocab</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">voc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Text vocabulary saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">text_vocab</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CorpusBuilder.save_vocab"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.save_vocab">[docs]</a>    <span class="k">def</span> <span class="nf">save_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the vocabulary from the current corpus and save it in a text file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__make_vocab</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Corpus not found! Cannot compute and save the vocabulary.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.set_status_path"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.set_status_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_status_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Path name for saving/loading a serialized instance of this class, without the corpus.\n</span>
<span class="sd">        Setting the Path does not save the instance, use :meth:`~CorpusBuilder.save_status()` for that.</span>

<span class="sd">        :param path: Status Path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_path</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status path updated to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.save_status"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.save_status">[docs]</a>    <span class="k">def</span> <span class="nf">save_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the serialized instance of this class in a pickle file, without the corpus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># save without corpus</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span> <span class="o">=</span> <span class="n">corpus</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status saved </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.load_status"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.load_status">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_status</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a previously serialized instance of this class.\n</span>
<span class="sd">        The corpus must be loaded separately with :meth:`~CorpusBuilder.load_corpus()`.</span>

<span class="sd">        :param path: Path to status file.</span>
<span class="sd">        :return: Instance of this class, without the corpus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dm</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading status </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span></div>

<div class="viewcode-block" id="CorpusBuilder.load_corpus"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.load_corpus">[docs]</a>    <span class="k">def</span> <span class="nf">load_corpus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the corpus from the list of pickle files passed as parameter.\n</span>
<span class="sd">        If no list is passed as parameter, load the corpus from the pickle files defined in</span>
<span class="sd">        :attr:`~CorpusBuilder.data_paths` during initialization of the instance.</span>

<span class="sd">        :param files: List of Paths of pickle corpus file to load.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span><span class="o">.</span><span class="n">pkl_corpus_files</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span><span class="p">,</span> <span class="o">*</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Path to use for serialization of an instance of this class.</span>

<span class="sd">        :return: Path to the :class:`CorpusBuilder` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__status_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataPaths</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the :class:`DataPaths` instance of the current instance.\n</span>
<span class="sd">        DataPaths is a collection of metadata for the current :class:`CorpusBuilder` instance.</span>

<span class="sd">        :return: :class:`DataPaths` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__paths</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">documents_are_split_in_words</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if :attr:`corpus` is a list of lists of words.</span>

<span class="sd">        :return: Boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__split</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the corpus of the current instance.</span>
<span class="sd">        The corpus can be a list of strings or a list of lists of words (default).</span>

<span class="sd">        :return: List of documents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corpus</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__corpus_iterator</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate over a list of text files and yield their content one at a time.</span>

<span class="sd">        :param paths: List of text files Paths, or single Path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">paths</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>  <span class="c1"># wrap inside list</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">corpus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="n">corpus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">corpus</span>

<div class="viewcode-block" id="CorpusBuilder.clean_doc"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.clean_doc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a sequence of regex substitutions on the given document.</span>

<span class="sd">        :param doc: Document to clean.</span>
<span class="sd">        :return: Document cleaned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unicode values available at https://www.unicodepedia.com/groups/</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;[^</span><span class="se">\U00000021</span><span class="s1">-</span><span class="se">\U0000024F</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(https?|www)[^ ]*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># remove links</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;( ?(&quot;</span><span class="se">\&#39;</span><span class="s1">?)|</span><span class="se">\&#39;</span><span class="s1">?&quot; | </span><span class="se">\&#39;</span><span class="s1">+|^</span><span class="se">\&#39;</span><span class="s1">|&#39;</span>
                     <span class="sa">r</span><span class="s1">&#39; ?\(+| ?\)+)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^|\t| )#&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ?@[a-zA-Z0-9_-]+[.,]? ?&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># remove usernames</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;@[^ ]*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([.|,]?[0-9]+[.|,]?)+&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># remove numeric values</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]</span><span class="si">{}</span><span class="s1">«»¼½¾©®×§¹²³º÷~;`^¡&amp;%&#39;</span>
                     <span class="sa">r</span><span class="s1">&#39;\U000000A0:/\-&quot;#,&lt;&gt;´=</span><span class="se">\\</span><span class="s1">|*!+?.·</span><span class="se">\&#39;</span><span class="s1">]&#39;</span>
                     <span class="sa">r</span><span class="s1">&#39;|_{2,}&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># remove specific characters</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]+@[a-z]+?&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># rests of emails</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(^( )+)|(( )+$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>  <span class="c1"># remove leading or trailing multiple spaces.</span>

        <span class="k">return</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="CorpusBuilder.doc_from_link"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.doc_from_link">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">doc_from_link</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download and extract the text body of a web page from the given URL, return None if problems during download or</span>
<span class="sd">        extraction arise.</span>

<span class="sd">        :param link: URL link of the web page.</span>
<span class="sd">        :return: Raw text body as a string or None if the document cannot be extracted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching html from </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">fetch_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">link</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Html fetched, starting extraction...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">trafilatura</span><span class="o">.</span><span class="n">bare_extraction</span><span class="p">(</span><span class="n">filecontent</span><span class="o">=</span><span class="n">html</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="n">target_language</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error extracting the text from the web page.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;raw_text&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CorpusBuilder.deduplicate_lines_in_txt"><a class="viewcode-back" href="../../read4me.datafactory.html#read4me.datafactory.CorpusBuilder.deduplicate_lines_in_txt">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deduplicate_lines_in_txt</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduplicate lines in the source text file.</span>
<span class="sd">        This method uses awk to perform deduplication.</span>

<span class="sd">        :param source: Path to text file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;_temp_txt_&quot;</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;awk &#39;!visited[$0]++&#39; </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;rm </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;mv </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Francesco Littarru.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>